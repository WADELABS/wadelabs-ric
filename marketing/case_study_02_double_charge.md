# Wadelabs Integrity Case File #02
**Title:** Multi-Tab Workflow Abuse in Checkout
**Severity:** HIGH
**Check ID:** RIC-02 (Multi-Tab Double-Action)

---

## üö® The Failure
The checkout flow for "Add-On Credits" lacked idempotency enforcement on the execution endpoint.

**Impact:**
A user opening two tabs and clicking "Purchase" simultaneously (or experiencing network lag/retry) triggers **two charges** for a single intended transaction. This creates immediate support overhead and chargeback risk.

## üì∏ Evidence Artifacts

### 1. Race Condition Log
**File:** `assertion_log_ric_02_race.jsonl`
```json
{"t": 100, "action": "submit_tab_1", "balance_pre": 500}
{"t": 105, "action": "submit_tab_2", "balance_pre": 500}
{"t": 200, "response_tab_1": "200 OK", "balance_post": 400} (Charged $100)
{"t": 210, "response_tab_2": "200 OK", "balance_post": 300} (Charged $100)
```

### 2. Visual Proof
**File:** `double_charge_repro.gif`
(Shows split screen: Tab A and Tab B submitting. Result: "Success" on both.)

---

## üõ†Ô∏è Remediation
**Status:** FIXED in v1.9.2

*   **Root Cause:** Backend checked inventory *before* optimizing database lock, allowing race condition window.
*   **Fix:** Implemented `Idempotency-Key` header requirement on `/api/v1/charge`. Database constraint added on `(user_id, order_id)`.
*   **Verification:** Re-ran RIC-02 (Pressure Variant). Result: 2nd request returns `409 Conflict` (Correct).

---

*Generated by Wadelabs Release Integrity Check (RIC)*
